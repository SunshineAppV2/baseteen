rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Funções Auxiliares ---
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Obtém dados do usuário atual (Custa 1 leitura)
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Helper to get Base/District IDs with fallback to Firestore Data
    // FORCE DB READ to avoid Stale Token issues
    function getUserBaseId() {
      return getUserData().baseId;
    }
    
    function getUserDistrictId() {
      return getUserData().districtId;
    }

    function getUserRegionId() {
      return getUserData().regionId;
    }

    function getUserAssociationId() {
      return getUserData().associationId;
    }

    function getUserUnionId() {
      return getUserData().unionId;
    }
    
    // Checks de Role
    // Checks de Role (Prioriza Custom Claims)
    function hasRole(role) {
      return (request.auth.token.keys().hasAll(['role']) && request.auth.token.role == role) ||
             (isSignedIn() 
              && exists(/databases/$(database)/documents/users/$(request.auth.uid))
              && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role);
    }
    
    function isOwnerOrAdmin() {
      // MASTER EMAIL HARDCODED: Case insensitive + fallback to roles
      return (request.auth.token.email != null && request.auth.token.email.lower() == 'master@baseteen.com') 
             || request.auth.token.role == 'master'
             || request.auth.token.role == 'admin'
             || hasRole('master') 
             || hasRole('admin') 
             || hasRole('coord_geral');
    }
    
    function isSecretary() {
      return request.auth.token.role == 'secretaria' || hasRole('secretaria') || isOwnerOrAdmin();
    }
    
    // Hierarquia
    function isUnionCoord() {
      return request.auth.token.role == 'coord_uniao' || hasRole('coord_uniao');
    }

    function isAssociationCoord() {
      return request.auth.token.role == 'coord_associacao' || hasRole('coord_associacao');
    }

    function isRegionCoord() {
      return request.auth.token.role == 'coord_regiao' || hasRole('coord_regiao');
    }

    function isDistrictCoord() {
      return request.auth.token.role == 'coord_distrital' || hasRole('coord_distrital');
    }
    
    function isBaseCoord() {
      return request.auth.token.role == 'coord_base' || hasRole('coord_base');
    }

    // Acesso Hierárquico para Leitura/Escrita de Submissões e Usuários
    function canManageArea(docData) {
      // Prioritize checking the USER'S scope against the target document's scope
      return isOwnerOrAdmin() ||
             (isUnionCoord() && getUserUnionId() == docData.unionId) ||
             (isAssociationCoord() && getUserAssociationId() == docData.associationId) ||
             (isRegionCoord() && getUserRegionId() == docData.regionId) ||
             (isDistrictCoord() && getUserDistrictId() == docData.districtId) ||
             (isBaseCoord() && getUserBaseId() == docData.baseId);
    }
    
    // --- Regras por Coleção ---

    // USERS
    match /users/{userId} {
      allow read: if isOwnerOrAdmin() || isSecretary() || 
                  request.auth.uid == userId ||
                  resource.data.email == request.auth.token.email || // Allow query by own email
                  canManageArea(resource.data) ||
                  (hasRole('membro') && resource.data.baseId == getUserBaseId()) ||
                  // Permite leitura pública de membros para o Play Quiz (Modo Simplificado)
                  (resource.data.role == 'membro');

      // Criação: Admins ou Coordenadores (Hierarquia)
      allow create: if isOwnerOrAdmin() || isSecretary() || 
                    canManageArea(request.resource.data) ||
                    // Self-registration (if enabled/applicable logic)
                    (request.auth.uid == userId && 
                      (request.resource.data.role == 'membro' || request.auth.token.email == 'master@baseteen.com'));
      
      
      // Update: Dono, Secretaria, Coord da área ou o próprio usuário
      allow update: if isOwnerOrAdmin() || isSecretary() ||
                    // Check token claims first (0 reads)
                    (request.auth.token.role == 'coord_base' && request.auth.token.baseId == resource.data.baseId) ||
                    (request.auth.token.role == 'coord_distrital' && request.auth.token.districtId == resource.data.districtId) ||
                    // Fallback to DB check
                    (isBaseCoord() && getUserBaseId() == resource.data.baseId) ||
                    (isDistrictCoord() && getUserDistrictId() == resource.data.districtId) ||
                    canManageArea(resource.data) ||
                    // Allow Coordinators to update XP/Stats for any participant (e.g. Visitors)
                    ((isBaseCoord() || isDistrictCoord()) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['xp', 'stats'])) ||
                    // Allow users to update their own profile and XP/stats (for quizzes, tasks, etc)
                    // Optimized Self-Update Rule: Allow users to update their own data.
                    // safely checking if 'role' is unchanged (using get() to avoid errors if field missing).
                    (request.auth.uid == userId && request.resource.data.get('role', null) == resource.data.get('role', null)));

      // Delete: Admin or Owner only
      allow delete: if isOwnerOrAdmin();
      
      // Subcoleção XP History
      match /xp_history/{historyId} {
        // Strict Read: User themselves, or their managers.
        allow read: if request.auth.uid == userId || 
                    isOwnerOrAdmin() || isSecretary() ||
                    (isDistrictCoord() && getUserDistrictId() == get(/databases/$(database)/documents/users/$(userId)).data.districtId) ||
                    (isBaseCoord() && getUserBaseId() == get(/databases/$(database)/documents/users/$(userId)).data.baseId);
        
        // Write: Managers or User (for own actions - quiz, task completion, etc)
        // Prioritize USER CHECK first to avoid expensive/failing get() calls
        allow create: if request.auth.uid == userId ||
                      isOwnerOrAdmin() || isSecretary() ||
                      (request.auth.token.role == 'coord_base' && request.auth.token.baseId == get(/databases/$(database)/documents/users/$(userId)).data.baseId) ||
                      (request.auth.token.role == 'coord_distrital' && request.auth.token.districtId == get(/databases/$(database)/documents/users/$(userId)).data.districtId) ||
                      (isBaseCoord() && getUserBaseId() == get(/databases/$(database)/documents/users/$(userId)).data.baseId) ||
                      (isDistrictCoord() && getUserDistrictId() == get(/databases/$(database)/documents/users/$(userId)).data.districtId);
        
        // Update/Delete: Only managers
        allow update, delete: if isOwnerOrAdmin() || isSecretary() ||
                              (request.auth.token.role == 'coord_base' && request.auth.token.baseId == get(/databases/$(database)/documents/users/$(userId)).data.baseId) ||
                              (request.auth.token.role == 'coord_distrital' && request.auth.token.districtId == get(/databases/$(database)/documents/users/$(userId)).data.districtId) ||
                              (isBaseCoord() && getUserBaseId() == get(/databases/$(database)/documents/users/$(userId)).data.baseId) ||
                              (isDistrictCoord() && getUserDistrictId() == get(/databases/$(database)/documents/users/$(userId)).data.districtId);
      }
      
      // Subcoleção Reading Progress
      match /reading_progress/{planId} {
        allow read: if request.auth.uid == userId || isOwnerOrAdmin();
        allow write: if request.auth.uid == userId || isOwnerOrAdmin();
      }
    }

    // TASKS (Requisitos) - Hierarchical Visibility
    match /tasks/{taskId} {
      // Read permissions based on visibility scope
      allow read: if isSignedIn() && (
        // Global tasks visible to all
        resource.data.visibilityScope == 'all' ||
        
        // Union tasks visible to users in that union
        (resource.data.visibilityScope == 'union' && getUserData().unionId == resource.data.unionId) ||
        
        // Association tasks visible to users in that association
        (resource.data.visibilityScope == 'association' && getUserData().associationId == resource.data.associationId) ||
        
        // Region tasks visible to users in that region
        (resource.data.visibilityScope == 'region' && getUserData().regionId == resource.data.regionId) ||
        
        // District tasks visible to users in that district
        (resource.data.visibilityScope == 'district' && getUserData().districtId == resource.data.districtId) ||
        
        // Base tasks visible to users in that base
        (resource.data.visibilityScope == 'base' && getUserData().baseId == resource.data.baseId) ||
        
        // Backward compatibility: old tasks without visibilityScope
        (!('visibilityScope' in resource.data) && (
          !('baseId' in resource.data) && !('districtId' in resource.data) || // Old general tasks
          resource.data.baseId == getUserData().baseId || // Old base tasks
          resource.data.districtId == getUserData().districtId // Old district tasks
        ))
      );
      
      // Create permissions based on coordinator role and scope
      allow create: if isSignedIn() && (
        // Admins can create any task
        isOwnerOrAdmin() || isSecretary() ||
        
        // Union coordinators can create union and global tasks
        (isUnionCoord() && request.resource.data.visibilityScope in ['all', 'union'] && 
         request.resource.data.unionId == getUserData().unionId) ||
        
        // Association coordinators can create association, region, district, and base tasks
        (isAssociationCoord() && request.resource.data.visibilityScope in ['association', 'region', 'district', 'base'] && 
         request.resource.data.associationId == getUserData().associationId) ||
        
        // Region coordinators can create region, district, and base tasks
        (isRegionCoord() && request.resource.data.visibilityScope in ['region', 'district', 'base'] && 
         request.resource.data.regionId == getUserData().regionId) ||
        
        // District coordinators can create district and base tasks
        (isDistrictCoord() && request.resource.data.visibilityScope in ['district', 'base'] && 
         request.resource.data.districtId == getUserData().districtId) ||
        
        // Base coordinators can create base tasks
        (isBaseCoord() && request.resource.data.visibilityScope == 'base' && 
         request.resource.data.baseId == getUserData().baseId)
      );
      
      // Update/Delete permissions
      allow update, delete: if isSignedIn() && (
        isOwnerOrAdmin() || isSecretary() ||
        
        // Coordinators can edit tasks they created in their scope
        (isUnionCoord() && resource.data.visibilityScope == 'union' && resource.data.unionId == getUserData().unionId) ||
        (isAssociationCoord() && resource.data.visibilityScope == 'association' && resource.data.associationId == getUserData().associationId) ||
        (isRegionCoord() && resource.data.visibilityScope == 'region' && resource.data.regionId == getUserData().regionId) ||
        (isDistrictCoord() && resource.data.visibilityScope == 'district' && resource.data.districtId == getUserData().districtId) ||
        (isBaseCoord() && resource.data.visibilityScope == 'base' && resource.data.baseId == getUserData().baseId) ||
        
        // Backward compatibility
        (!('visibilityScope' in resource.data) && (
          (isDistrictCoord() && resource.data.districtId == getUserData().districtId) ||
          (isBaseCoord() && resource.data.baseId == getUserData().baseId)
        ))
      );
    }

    // SETTINGS (Gamification/Reading)
    match /settings/{docId} {
        allow read: if isSignedIn();
        allow write: if isOwnerOrAdmin();
    }

    // --- NEW HIERARCHY ---
    match /unions/{uId} {
        allow read: if true;
        allow write: if isOwnerOrAdmin();
    }
    match /associations/{aId} {
        allow read: if true;
        allow write: if isOwnerOrAdmin() || (isUnionCoord() && getUserUnionId() == resource.data.unionId);
    }
    match /regions/{rId} {
        allow read: if true;
        allow write: if isOwnerOrAdmin() || (isAssociationCoord() && getUserAssociationId() == resource.data.associationId);
    }
 
    // DISTRICTS & BASES (Estrutura)
    match /districts/{dId} {
        // All users can read districts (needed for registration filters)
        allow read: if true;
        allow create: if isOwnerOrAdmin() || canManageArea(request.resource.data); 
        allow write: if isOwnerOrAdmin() || canManageArea(resource.data);
    }
    match /bases/{bId} {
        // All users can read bases (needed for registration filters)
        allow read: if true;
        
        // District Coords can create Bases in their district
        allow create: if isOwnerOrAdmin() || canManageArea(request.resource.data);
        
        allow write: if isOwnerOrAdmin() || canManageArea(resource.data) || (isBaseCoord() && bId == getUserBaseId());
    }

    // SUBMISSIONS (Provas)
    match /submissions/{submissionId} {
      allow read: if isOwnerOrAdmin() || isSecretary() || 
                  (isSignedIn() && resource.data.userId == request.auth.uid) ||
                  canManageArea(resource.data);
      
      allow create: if isSignedIn() 
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.status == 'pending';
                    
      allow update, delete: if isOwnerOrAdmin() || isSecretary() || canManageArea(resource.data);
    }

    // BASE SUBMISSIONS (Provas Coletivas de Bases)
    match /base_submissions/{submissionId} {
      // Leitura: Permitido para todos usuários logados para permitir cálculo de Ranking global
      allow read: if isSignedIn();
      
      // Criação: Apenas Coord de Base (para sua própria base)
      allow create: if isBaseCoord() && 
                    request.resource.data.baseId == getUserBaseId() &&
                    request.resource.data.submittedBy == request.auth.uid &&
                    request.resource.data.status == 'pending';
      
      // Atualização: Admins, Secretaria, ou Coordenadores da hierarquia (para aprovar/reprovar)
      allow update: if isOwnerOrAdmin() || isSecretary() || canManageArea(resource.data);
      
      // Exclusão: Apenas Admins
      allow delete: if isOwnerOrAdmin();
    }
    
    // NOTIFICATIONS
    match /notifications/{notifId} {
        allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
        allow create: if isOwnerOrAdmin() || isSecretary() || canManageArea(get(/databases/$(database)/documents/users/$(request.resource.data.userId)).data) || request.resource.data.userId == request.auth.uid;
        allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    // NOTICES (Mural)
    match /notices/{noticeId} {
        allow read: if isSignedIn();
        allow write: if isOwnerOrAdmin() || isSecretary() || hasRole('coord_geral');
    }
    
    // QUIZ QUESTIONS
    match /quiz_questions/{questionId} {
      allow read: if isSignedIn();
      allow write: if isOwnerOrAdmin();
    }
    
    // QUIZ HISTORY (Resultados)
    match /quiz_history/{historyId} {
        allow read: if isSignedIn();
        allow write: if isOwnerOrAdmin() || isDistrictCoord() || isBaseCoord();
    }

    // MASTER QUIZZES (Play Quiz / Arena)
    match /master_quizzes/{quizId} {
        allow read: if isSignedIn();
        allow write: if isOwnerOrAdmin() || isBaseCoord();
    }

    // LOGS
    // LOGS
    match /system_logs/{logId} {
      allow read: if isOwnerOrAdmin();
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    // --- ATTENDANCE & CRM ---
    
    // Quarters (Trimestres - Datas do Master)
    match /quarters/{quarterId} {
        allow read: if isSignedIn();
        allow write: if isOwnerOrAdmin();
    }

    // Attendance Config (Pontuação por Base)
    match /bases/{baseId}/attendance_config/{configId} {
        allow read: if isSignedIn();
        allow write: if isOwnerOrAdmin() || isSecretary() || 
                      (isBaseCoord() && baseId == getUserBaseId()) ||
                      canManageArea(get(/databases/$(database)/documents/bases/$(baseId)).data);
    }

    // Attendance Records (A Chamada em si)
    match /attendance_days/{dayId} {
        allow read: if isSignedIn();
        
        allow create: if isOwnerOrAdmin() || isSecretary() || canManageArea(request.resource.data);
                      
        allow update: if isOwnerOrAdmin() || isSecretary() || canManageArea(resource.data);
                      
        allow delete: if isOwnerOrAdmin() || isSecretary() || canManageArea(resource.data);
    }

    // Subscriptions Collection
    match /subscriptions/{subscriptionId} {
      allow read: if isSignedIn();
      allow create, update: if isOwnerOrAdmin();
      allow delete: if isOwnerOrAdmin();
    }

    // Payments Collection
    match /payments/{paymentId} {
      allow read, write: if isOwnerOrAdmin();
    }

    // Base Quizzes Collection
    match /base_quizzes/{quizId} {
      allow read: if isSignedIn();
      allow create: if isOwnerOrAdmin() || isSecretary() || canManageArea(request.resource.data);
      allow update, delete: if isOwnerOrAdmin() || canManageArea(resource.data);
    }

    // Base Quiz Attempts
    match /base_quiz_attempts/{attemptId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow delete: if isOwnerOrAdmin() || (isSignedIn() && resource.data.userId == request.auth.uid);
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid || 
        isOwnerOrAdmin() || 
        isSecretary() ||
        canManageArea(resource.data)
      );
    }
  }
}
